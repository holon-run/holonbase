# E2E test for pr-fix mode with local bare repo
# This test verifies the complete pr-fix publishing flow:
# 1. Context collection (simulated with fixtures)
# 2. Agent execution in pr-fix mode (mock driver)
# 3. Publish: apply/commit/push diff.patch to PR head branch
# 4. Publish: GitHub publisher posts replies/summary (with mock server)
#
# This test would have caught:
# - Missing head_ref parsing issues
# - Missing token propagation (GITHUB_TOKEN -> GIT_TOKEN)
# - Git publisher push failures
# - Branch checkout/creation issues

[!docker] skip 'docker not available'

# Create a bare remote repository
mkdir remote
exec git -C remote init --bare
exists remote/refs
exists remote/objects

# Create the "origin" clone workspace
mkdir work
mkdir work/pkg
exec git -C work init
exec git -C work config user.email "test@example.com"
exec git -C work config user.name "Test User"
exec git -C work remote add origin ../remote

# Create initial file and commit to main branch
exec git -C work add pkg/process.go
exec git -C work commit -m 'initial commit'
# Rename master to main for consistency
exec git -C work branch -M main
exec git -C work push -u origin main

# Create the PR head branch
exec git -C work checkout -b feature/add-error-handling
# Modify the file to add TODO comment for PR
exec sh -c 'printf "package handler\n\nfunc ProcessData(data string) {\n    // TODO: add error handling\n    result := transform(data)\n    send(result)\n}\n" > work/pkg/process.go'
exec git -C work add pkg/process.go
exec git -C work commit -m 'add error handling placeholder'
exec git -C work push -u origin feature/add-error-handling

# Verify branch exists in remote
exec git -C remote branch

# Create input context directory structure (simulates what GitHub collector creates)
mkdir input
mkdir input/context
mkdir input/context/github

# Set environment for mock driver and pr-fix mode
env HOLON_CLAUDE_DRIVER=mock
env HOLON_CLAUDE_MOCK_FIXTURE=/holon/input/context/fixture.json
env HOLON_MODE=pr-fix

# Run holon run with the pre-populated PR context
exec holon run --agent default --goal 'Fix the review comments in PR https://github.com/test/repo/pull/456' --workspace work --input input --output out --image golang:1.22

# Verify outputs exist
exists out/manifest.json
exists out/diff.patch
exists out/summary.md
exists out/pr-fix.json

# Verify manifest structure
exec grep -q '"status": "completed"' out/manifest.json
exec grep -q '"outcome": "success"' out/manifest.json

# Add git publisher metadata to manifest.json
# The git publisher requires these fields in manifest.metadata (see pkg/publisher/git/publisher.go:260-283)
exec sh -c 'cat out/manifest.json | python3 -c "import sys, json; m = json.load(sys.stdin); m[\"metadata\"][\"branch\"] = \"feature/add-error-handling\"; m[\"metadata\"][\"commit_message\"] = \"Fix review comments: Add error handling\"; m[\"metadata\"][\"commit\"] = \"true\"; m[\"metadata\"][\"push\"] = \"true\"; m[\"metadata\"][\"remote\"] = \"origin\"; print(json.dumps(m, indent=2))" > out/manifest.json.tmp && mv out/manifest.json.tmp out/manifest.json'

# Verify manifest now has git publisher metadata
exec grep -q '"branch": "feature/add-error-handling"' out/manifest.json
exec grep -q '"commit": "true"' out/manifest.json
exec grep -q '"push": "true"' out/manifest.json

# Verify diff.patch contains the changes
exec grep -q 'errors.New' out/diff.patch
exec grep -q 'return err' out/diff.patch

# Verify pr-fix.json structure
exec python3 -m json.tool out/pr-fix.json
exec grep -q '"review_replies"' out/pr-fix.json
exec grep -q '"comment_id":789' out/pr-fix.json
exec grep -q '"status":"fixed"' out/pr-fix.json

# NOW TEST THE PUBLISH FLOW
# Clone a fresh workspace for publishing (simulating publish workspace preparation)
mkdir publish-workspace
exec git -C publish-workspace init
exec git -C publish-workspace config user.email "test@example.com"
exec git -C publish-workspace config user.name "Test User"
exec git -C publish-workspace remote add origin ../remote
exec git -C publish-workspace fetch origin feature/add-error-handling
exec git -C publish-workspace checkout feature/add-error-handling

# Verify file is in original state (before patch)
! exec grep -q 'errors.New' publish-workspace/pkg/process.go

# Set up environment for publish flow
# HOLON_WORKSPACE points to publish workspace
env HOLON_WORKSPACE=publish-workspace
# GITHUB_TOKEN will be propagated to GIT_TOKEN for git push
env GITHUB_TOKEN=test_token_123

# Test the git publisher with apply/commit/push
# This should: 1) checkout the branch, 2) apply the patch, 3) commit, 4) push
# NOTE: The manifest.json was modified above to include the git publisher metadata
# fields (branch, commit, and push configuration) as expected by
# pkg/publisher/git/publisher.go:260-283.
exec holon publish --provider git --target origin/feature/add-error-handling --output out

# Verify the changes were applied to the workspace
exec grep -q 'errors.New' publish-workspace/pkg/process.go
exec grep -q 'func ProcessData(data string) error' publish-workspace/pkg/process.go

# Verify a commit was created with the changes
exec git -C publish-workspace log --oneline -1
exec git -C publish-workspace show --stat HEAD

# Verify the commit exists in the remote bare repository
exec git -C remote log feature/add-error-handling --oneline

# Verify the branch was updated in the remote
exec git -C remote branch

-- work/pkg/process.go --
package handler

func ProcessData(data string) {
    result := transform(data)
    send(result)
}

-- input/context/github/pr.json --
{
  "number": 456,
  "title": "Add error handling",
  "state": "open",
  "author": "prauthor",
  "body": "This PR adds error handling.",
  "url": "https://github.com/test/repo/pull/456",
  "base_ref": "main",
  "head": {
    "ref": "feature/add-error-handling"
  },
  "base_sha": "abc123",
  "head_sha": "def456",
  "created_at": "2024-01-01T00:00:00Z",
  "updated_at": "2024-01-01T00:00:00Z"
}

-- input/context/github/review_threads.json --
[
  {
    "id": 789,
    "path": "pkg/process.go",
    "line": 4,
    "start_line": 4,
    "side": "RIGHT",
    "author": "reviewer1",
    "body": "Please add actual error handling instead of TODO",
    "diff_hunk": "@@ -1,6 +1,10 @@\n func ProcessData(data string) {\n+    // TODO: add error handling\n     result := transform(data)\n     send(result)\n }",
    "resolved": false,
    "url": "https://github.com/test/repo/pull/456/comments/789",
    "created_at": "2024-01-01T01:00:00Z",
    "replies": []
  }
]

-- input/context/github/pr.diff --
diff --git a/pkg/process.go b/pkg/process.go
index abc123..def456 100644
--- a/pkg/process.go
+++ b/pkg/process.go
@@ -1,6 +1,10 @@
 package handler

 func ProcessData(data string) {
-    // TODO: add error handling
+    result, err := transform(data)
+    if err != nil {
+        return err
+    }
     send(result)
 }

-- input/context/pr-fix.schema.json --
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "PR Fix Output",
  "type": "object",
  "properties": {
    "review_replies": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "comment_id": { "type": "number" },
          "status": { "type": "string" },
          "message": { "type": "string" },
          "action_taken": { "type": "string" }
        },
        "required": ["comment_id", "status"]
      }
    }
  }
}

-- input/context/fixture.json --
{
  "version": "v1",
  "description": "Fix PR review comments about error handling",
  "operations": [
    {
      "type": "write_file",
      "path": "pkg/process.go",
      "content": "package handler\n\nimport (\n    \"errors\"\n)\n\nfunc ProcessData(data string) error {\n    result, err := transform(data)\n    if err != nil {\n        return err\n    }\n    return send(result)\n}\n\nfunc transform(data string) (string, error) {\n    if data == \"\" {\n        return \"\", errors.New(\"empty input\")\n    }\n    return data + \" processed\", nil\n}\n\nfunc send(result string) error {\n    if result == \"\" {\n        return errors.New(\"nothing to send\")\n    }\n    return nil\n}\n"
    },
    {
      "type": "write_output",
      "path": "pr-fix.json",
      "content": "{\"review_replies\":[{\"comment_id\":789,\"status\":\"fixed\",\"message\":\"Added error handling with proper validation\",\"action_taken\":\"Implemented error handling for transform and send functions\"}]}"
    }
  ],
  "outcome": {
    "success": true,
    "result_text": "Fixed error handling in PR",
    "summary": "# Summary\n\nFixed error handling as requested in review comments."
  }
}
