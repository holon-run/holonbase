[!docker] skip 'docker not available'

mkdir work
mkdir work/pkg
mkdir work/pkg/context
mkdir out
mkdir input
mkdir input/context

# Initialize git in workspace (required for mock driver to generate diff.patch)
exec git -C work init
exec git -C work config user.email "test@example.com"
exec git -C work config user.name "Test User"
exec git -C work add pkg/context/loader.go
exec git -C work commit -m 'initial commit'

# Run holon in pr-fix mode with mock driver
# The fixture file is provided as a txtar section below
env HOLON_CLAUDE_DRIVER=mock HOLON_CLAUDE_MOCK_FIXTURE=/holon/input/context/fixture.json HOLON_MODE=pr-fix
exec holon run --agent default --goal 'Fix PR review comments' --workspace work --input input --output out --image golang:1.22

# Verify outputs
exists out/manifest.json
exists out/diff.patch
exists out/summary.md
exists out/pr-fix.json

# Verify pr-fix.json structure
exec python3 -m json.tool out/pr-fix.json
grep '"review_replies"' out/pr-fix.json
grep '"status":"fixed"' out/pr-fix.json

# Initial file (workspace snapshot)
-- work/pkg/context/loader.go --
func loadContext() *Context {
    return nil
}

-- input/context/fixture.json --
{
  "version": "v1",
  "description": "PR fix for review comments",
  "operations": [
    {
      "type": "write_file",
      "path": "pkg/context/loader.go",
      "content": "func loadContext() *Context {\n    if cfg == nil {\n        return &Context{}\n    }\n    return parseContext(cfg)\n}\n"
    },
    {
      "type": "write_output",
      "path": "pr-fix.json",
      "content": "{\"review_replies\":[{\"comment_id\":123456,\"status\":\"fixed\",\"message\":\"Added nil check\",\"action_taken\":\"Added guard clause for nil config\"}],\"checks\":[{\"name\":\"ci/test\",\"conclusion\":\"failure\",\"fix_status\":\"fixed\",\"message\":\"Fixed nil dereference in tests\"}]}"
    }
  ],
  "outcome": {
    "success": true,
    "result_text": "Fixed PR review comments"
  }
}
