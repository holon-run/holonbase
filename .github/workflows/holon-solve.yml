name: Holon Solve (Reusable)

on:
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue or PR number'
        required: false
        type: number
        default: 0
      comment_id:
        description: 'Comment ID for feedback reactions and replies'
        required: false
        type: number
        default: 0
      comment_body:
        description: 'Comment body (for auto mode detection)'
        required: false
        type: string
        default: ''
      mode:
        description: 'Execution mode (solve, pr-fix, plan, review). Empty = auto-detect'
        required: false
        type: string
        default: ''
      base:
        description: 'Base branch for PR creation (empty = repository default branch)'
        required: false
        type: string
        default: ''
      agent:
        description: 'Agent bundle reference'
        required: false
        type: string
        default: ''
      log_level:
        description: 'Log level (debug, info, progress, minimal)'
        required: false
        type: string
        default: 'progress'
      assistant_output:
        description: 'Assistant output mode (none, stream)'
        required: false
        type: string
        default: 'none'
      workspace:
        description: 'Workspace path (default: .)'
        required: false
        type: string
        default: '.'
      input_dir:
        description: 'Input directory path for artifact packaging (empty = temp dir, kept for debug)'
        required: false
        type: string
        default: ''
      output_dir:
        description: 'Output directory path for artifact packaging (empty = temp dir, kept for debug)'
        required: false
        type: string
        default: ''
      version:
        description: 'Holon version to download from releases'
        required: false
        type: string
        default: 'latest'
      build_from_source:
        description: 'Build holon from source'
        required: false
        type: boolean
        default: false
      holon_repository:
        description: 'Holon repository for building from source'
        required: false
        type: string
        default: 'holon-run/holon'
      runs_on:
        description: >
          Runner labels as a plain string (e.g., 'ubuntu-latest' or 'self-hosted')
          or JSON array string (e.g., '["ubuntu-latest"]' or '["self-hosted","linux","x64"]').
          Plain strings are automatically converted to arrays.
        required: false
        type: string
        default: 'ubuntu-latest'
    secrets:
      anthropic_auth_token:
        description: 'Anthropic Auth Token (legacy: anthropic_api_key also supported)'
        required: true
      anthropic_api_key:
        description: 'Legacy alias for anthropic_auth_token (deprecated)'
      holon_github_token:
        description: 'GitHub Token (optional; defaults to github.token)'
        required: false
      anthropic_base_url:
        description: 'Anthropic Base URL'
        required: false

    outputs:
      result:
        description: 'Execution result'
        value: ${{ jobs.holon-solve.outputs.result }}
      summary:
        description: 'Execution summary path'
        value: ${{ jobs.holon-solve.outputs.summary }}

jobs:
  holon-solve:
    runs-on: ${{ (startsWith(inputs.runs_on, '[') && fromJSON(inputs.runs_on)) || inputs.runs_on || 'ubuntu-latest' }}
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    outputs:
      result: ${{ steps.result.outputs.result }}
      summary: ${{ steps.result.outputs.summary }}
    steps:
      - name: Normalize context
        id: ctx
        run: |
          set -euo pipefail

          EVENT_NAME='${{ github.event_name }}'

          ISSUE_NUMBER_INPUT='${{ inputs.issue_number }}'
          if [ -n "$ISSUE_NUMBER_INPUT" ] && [ "$ISSUE_NUMBER_INPUT" != '0' ]; then
            ISSUE_NUMBER="$ISSUE_NUMBER_INPUT"
          else
            ISSUE_NUMBER='${{ github.event.issue.number }}'
            if [ -z "$ISSUE_NUMBER" ]; then
              ISSUE_NUMBER='${{ github.event.pull_request.number }}'
            fi
          fi

          if [ -z "$ISSUE_NUMBER" ] || [ "$ISSUE_NUMBER" = '0' ]; then
            echo "::error::Unable to determine issue/PR number. Provide inputs.issue_number." >&2
            exit 1
          fi

          IS_PR='false'
          if [ -n '${{ github.event.issue.pull_request.url }}' ] || [ -n '${{ github.event.pull_request.number }}' ]; then
            IS_PR='true'
          fi

          COMMENT_BODY="$INPUT_COMMENT_BODY"
          if [ -z "$COMMENT_BODY" ] && [ "$EVENT_NAME" = 'issue_comment' ]; then
            COMMENT_BODY="$EVENT_COMMENT_BODY"
          fi

          INPUT_DIR_INPUT='${{ inputs.input_dir }}'
          if [ -n "$INPUT_DIR_INPUT" ]; then
            INPUT_DIR="$INPUT_DIR_INPUT"
            mkdir -p "$INPUT_DIR"
          else
            INPUT_DIR="$(mktemp -d -t holon-input-XXXXXX)"
          fi

          OUTPUT_DIR_INPUT='${{ inputs.output_dir }}'
          if [ -n "$OUTPUT_DIR_INPUT" ]; then
            OUTPUT_DIR="$OUTPUT_DIR_INPUT"
            mkdir -p "$OUTPUT_DIR"
          else
            OUTPUT_DIR="$(mktemp -d -t holon-output-XXXXXX)"
          fi

          echo "INPUT_DIR=$INPUT_DIR" >> "$GITHUB_ENV"
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> "$GITHUB_ENV"
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
          echo "is_pr=$IS_PR" >> "$GITHUB_OUTPUT"

          # Safely output comment body even if it contains HTML/markdown
          # Use base64 encoding to handle arbitrary content
          COMMENT_B64="$(printf '%s' "$COMMENT_BODY" | base64 -w 0)"
          echo "comment_body_b64=$COMMENT_B64" >> "$GITHUB_OUTPUT"

          echo "input_dir=$INPUT_DIR" >> "$GITHUB_OUTPUT"
          echo "output_dir=$OUTPUT_DIR" >> "$GITHUB_OUTPUT"
        env:
          INPUT_COMMENT_BODY: ${{ inputs.comment_body }}
          EVENT_COMMENT_BODY: ${{ github.event.comment.body }}

      - name: Gate execution
        id: gate
        run: |
          set -euo pipefail

          SHOULD_RUN='false'
          REASON='Not eligible'
          GOAL_HINT=''

          # Decode comment body from base64 (handles HTML/markdown safely)
          if [ -n "${COMMENT_BODY_B64:-}" ]; then
            if ! COMMENT_BODY="$(printf '%s' "$COMMENT_BODY_B64" | base64 -d 2>/dev/null)"; then
              echo "Warning: failed to decode COMMENT_BODY_B64 as base64; proceeding with empty COMMENT_BODY" >&2
              COMMENT_BODY=''
            fi
          else
            COMMENT_BODY=''
          fi

          # Avoid bot loops
          if [ "$ACTOR" = 'holonbot[bot]' ]; then
            REASON='Actor is holonbot[bot]'
            echo "should_run=$SHOULD_RUN" >> "$GITHUB_OUTPUT"
            echo "reason=$REASON" >> "$GITHUB_OUTPUT"
            echo "goal_hint=$GOAL_HINT" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$EVENT_NAME" = 'issue_comment' ] && [ "$EVENT_ACTION" = 'created' ]; then
            # Normalize first non-empty line (strip CR, trim whitespace)
            FIRST_LINE="$(printf '%s\n' "$COMMENT_BODY" | tr '\r' '\n' | sed '/./{p;q}' | xargs || true)"

            # Check if the comment is exactly "@holonbot" or starts with "@holonbot " (with space)
            # This pattern matches both "@holonbot" alone and "@holonbot " followed by text
            # The xargs command trims trailing whitespace, so multiple spaces are normalized to one
            # The check for "@holonbot "* ensures we don't match "@holonbot123" or similar
            if [[ "$FIRST_LINE" == "@holonbot" ]] || [[ "$FIRST_LINE" == "@holonbot "* ]]; then
              # Extract trailing text after "@holonbot", then drop a single leading space if present
              # If the comment is exactly "@holonbot", GOAL_HINT will be empty (acceptable)
              GOAL_HINT="${FIRST_LINE#@holonbot}"
              GOAL_HINT="${GOAL_HINT# }"
              # If user provided a message on subsequent lines, pick the first non-empty line as hint
              if [ -z "$GOAL_HINT" ]; then
                GOAL_HINT="$(printf '%s\n' "$COMMENT_BODY" | tr '\r' '\n' | sed '1d;/./{s/^[[:space:]]*//;s/[[:space:]]*$//;p;q}')"
              fi
              echo "✅ Trigger path: free-form command"
              echo "   Goal hint: $GOAL_HINT"
            else
              REASON="Comment command not recognized: '$FIRST_LINE'"
              echo "should_run=$SHOULD_RUN" >> "$GITHUB_OUTPUT"
              echo "reason=$REASON" >> "$GITHUB_OUTPUT"
              echo "goal_hint=$GOAL_HINT" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            if [ "$IS_PR" = 'true' ]; then
              # Disallow fork PRs
              IS_CROSS_REPO="$(gh api "repos/$REPO/pulls/$ISSUE_NUMBER" --jq '.head.repo.full_name != .base.repo.full_name' 2>/dev/null || echo 'true')"
              if [ "$IS_CROSS_REPO" = 'true' ]; then
                REASON='PR is from a fork/cross-repo head; not supported'
                echo "should_run=$SHOULD_RUN" >> "$GITHUB_OUTPUT"
                echo "reason=$REASON" >> "$GITHUB_OUTPUT"
                echo "goal_hint=$GOAL_HINT" >> "$GITHUB_OUTPUT"
                exit 0
              fi
            fi

            # Require write/maintain/admin permissions
            PERMISSION="$(gh api "repos/$REPO/collaborators/$ACTOR/permission" --jq '.permission' 2>/dev/null || echo '')"
            if [ "$PERMISSION" != 'admin' ] && [ "$PERMISSION" != 'maintain' ] && [ "$PERMISSION" != 'write' ]; then
              REASON="Insufficient permissions for $ACTOR: ${PERMISSION:-none}"
              echo "should_run=$SHOULD_RUN" >> "$GITHUB_OUTPUT"
              echo "reason=$REASON" >> "$GITHUB_OUTPUT"
              echo "goal_hint=$GOAL_HINT" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            SHOULD_RUN='true'
            REASON='Comment gates passed'
          elif [ "$EVENT_NAME" = 'issues' ]; then
            if [ "$EVENT_ACTION" = 'labeled' ] && [ "$LABEL_NAME" = 'holon' ]; then
              SHOULD_RUN='true'
              REASON='Issue labeled holon'
            elif [ "$EVENT_ACTION" = 'assigned' ] && [ "$ASSIGNEE_TYPE" = 'Bot' ]; then
              SHOULD_RUN='true'
              REASON='Issue assigned to Bot'
            else
              REASON='Issue event not eligible'
            fi
          elif [ "$EVENT_NAME" = 'pull_request' ] && [ "$EVENT_ACTION" = 'labeled' ]; then
            if [ "$LABEL_NAME" = 'holon' ]; then
              SHOULD_RUN='true'
              REASON='PR labeled holon'
            else
              REASON='PR label not eligible'
            fi
          else
            SHOULD_RUN='true'
            REASON='Default allow'
          fi

          echo "should_run=$SHOULD_RUN" >> "$GITHUB_OUTPUT"
          echo "reason=$REASON" >> "$GITHUB_OUTPUT"
          echo "goal_hint=$GOAL_HINT" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.holon_github_token || github.token }}
          EVENT_NAME: ${{ github.event_name }}
          EVENT_ACTION: ${{ github.event.action }}
          REPO: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          ISSUE_NUMBER: ${{ steps.ctx.outputs.issue_number }}
          IS_PR: ${{ steps.ctx.outputs.is_pr }}
          COMMENT_BODY_B64: ${{ steps.ctx.outputs.comment_body_b64 }}
          LABEL_NAME: ${{ github.event.label.name }}
          ASSIGNEE_TYPE: ${{ github.event.assignee.type }}

      - name: Add initial reaction (eyes)
        if: steps.gate.outputs.should_run == 'true' && inputs.comment_id != 0
        run: |
          set -euo pipefail

          COMMENT_ID='${{ inputs.comment_id }}'
          REPO='${{ github.repository }}'

          # Add eyes reaction idempotently (ignore errors if already present)
          gh api --silent -f content='eyes' "repos/$REPO/issues/comments/$COMMENT_ID/reactions" 2>/dev/null || true
        env:
          GH_TOKEN: ${{ secrets.holon_github_token || github.token }}

      - name: Resolve base branch
        id: base
        if: steps.gate.outputs.should_run == 'true'
        run: |
          set -euo pipefail

          BASE="$INPUT_BASE"
          if [ -z "$BASE" ]; then
            BASE="$EVENT_DEFAULT_BRANCH"
          fi
          if [ -z "$BASE" ]; then
            BASE="$(gh api "repos/$REPO" --jq '.default_branch')"
          fi

          if [ -z "$BASE" ] || [ "$BASE" = 'null' ]; then
            echo "::warning::Unable to resolve repository default branch; falling back to 'main'" >&2
            BASE='main'
          fi

          echo "base=$BASE" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.holon_github_token || github.token }}
          REPO: ${{ github.repository }}
          INPUT_BASE: ${{ inputs.base }}
          EVENT_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}

      - name: Checkout repository
        if: steps.gate.outputs.should_run == 'true' && steps.ctx.outputs.is_pr != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to avoid shallow clone issues

      - name: Resolve PR checkout ref
        id: pr-ref
        if: steps.gate.outputs.should_run == 'true' && steps.ctx.outputs.is_pr == 'true'
        run: |
          set -euo pipefail

          if [ -n "${EVENT_PR_HEAD_SHA:-}" ]; then
            echo "ref=$EVENT_PR_HEAD_SHA" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          REF="$(gh api "repos/$REPO/pulls/$ISSUE_NUMBER" --jq '.head.sha')"
          if [ -z "$REF" ] || [ "$REF" = 'null' ]; then
            echo "::error::Unable to resolve PR head sha for $REPO#$ISSUE_NUMBER" >&2
            exit 1
          fi

          echo "ref=$REF" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.holon_github_token || github.token }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ steps.ctx.outputs.issue_number }}
          EVENT_PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}

      - name: Checkout repository (PR)
        if: steps.gate.outputs.should_run == 'true' && steps.ctx.outputs.is_pr == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-ref.outputs.ref }}
          fetch-depth: 0  # Fetch all history to avoid shallow clone issues

      - name: Detect execution mode
        id: detect
        if: steps.gate.outputs.should_run == 'true'
        run: |
          set -euo pipefail

          PROVIDED_MODE="${{ inputs.mode }}"

          IS_PR='${{ steps.ctx.outputs.is_pr }}'

          # If mode is explicitly provided, use it
          if [ -n "$PROVIDED_MODE" ]; then
            echo "mode=$PROVIDED_MODE" >> "$GITHUB_OUTPUT"
            echo "✅ Using provided mode: $PROVIDED_MODE"
            exit 0
          fi

          if [ "$IS_PR" = 'true' ]; then
            echo "mode=pr-fix" >> "$GITHUB_OUTPUT"
            echo "✅ Detected: PR → mode=pr-fix"
          else
            echo "mode=solve" >> "$GITHUB_OUTPUT"
            echo "✅ Detected: Issue → mode=solve"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.holon_github_token || github.token }}

      - name: Write input metadata
        id: input-meta
        if: always()
        run: |
          set -euo pipefail

          INPUT_DIR='${{ steps.ctx.outputs.input_dir }}'
          mkdir -p "$INPUT_DIR"

          # Persist raw GitHub event payload for debugging/repro
          if [ -n "${GITHUB_EVENT_PATH:-}" ] && [ -f "$GITHUB_EVENT_PATH" ]; then
            cp "$GITHUB_EVENT_PATH" "$INPUT_DIR/event.json"
          fi

          EVENT_NAME='${{ github.event_name }}'
          EVENT_ACTION='${{ github.event.action }}'
          ACTOR='${{ github.actor }}'
          REPO='${{ github.repository }}'

          ISSUE_NUMBER='${{ steps.ctx.outputs.issue_number }}'
          IS_PR='${{ steps.ctx.outputs.is_pr }}'
          SHOULD_RUN="$GATE_SHOULD_RUN"
          REASON="$GATE_REASON"
          GOAL_HINT="$GATE_GOAL_HINT"

          # Get comment_id from input (if available)
          # Default to 0 if empty to ensure valid JSON for --argjson
          COMMENT_ID='${{ inputs.comment_id }}'
          if [ -z "$COMMENT_ID" ] || [ "$COMMENT_ID" = '' ]; then
            COMMENT_ID='0'
          fi

          MODE=''
          if [ "$SHOULD_RUN" = 'true' ]; then
            MODE='${{ steps.detect.outputs.mode }}'
          fi

          jq -n \
            --arg event_name "$EVENT_NAME" \
            --arg event_action "$EVENT_ACTION" \
            --arg actor "$ACTOR" \
            --arg repository "$REPO" \
            --arg issue_number "$ISSUE_NUMBER" \
            --arg is_pr "$IS_PR" \
            --arg should_run "$SHOULD_RUN" \
            --arg reason "$REASON" \
            --arg mode "$MODE" \
            --arg goal_hint "$GOAL_HINT" \
            --argjson comment_id "$COMMENT_ID" \
            '{
              event: {name: $event_name, action: $event_action, actor: $actor},
              target: {repository: $repository, issue_number: ($issue_number | tonumber), is_pr: ($is_pr == "true")},
              gate: {should_run: ($should_run == "true"), reason: $reason},
              mode: $mode,
              trigger: {goal_hint: $goal_hint, comment_id: $comment_id}
            }' > "$INPUT_DIR/workflow.json"
        env:
          GATE_SHOULD_RUN: ${{ steps.gate.outputs.should_run }}
          GATE_REASON: ${{ steps.gate.outputs.reason }}
          GATE_GOAL_HINT: ${{ steps.gate.outputs.goal_hint }}

      - name: Ensure Docker daemon
        if: steps.gate.outputs.should_run == 'true' && runner.os == 'Linux'
        run: |
          if ! docker info >/dev/null 2>&1; then
            sudo systemctl start docker || sudo service docker start
          fi
          docker info

      - name: Run Holon
        id: run
        if: steps.gate.outputs.should_run == 'true'
        uses: holon-run/holon@main
        env:
          HOLON_MODEL: ${{ vars.HOLON_MODEL || 'claude-sonnet-4-5-20250929' }}
        with:
          ref: "${{ github.repository }}#${{ steps.ctx.outputs.issue_number }}"
          mode: ${{ steps.detect.outputs.mode }}
          base: ${{ steps.base.outputs.base }}
          agent: ${{ inputs.agent }}
          anthropic_auth_token: ${{ secrets.anthropic_auth_token || secrets.anthropic_api_key }}
          anthropic_base_url: ${{ secrets.anthropic_base_url || 'https://api.anthropic.com' }}
          github_token: ${{ secrets.holon_github_token }}
          log_level: ${{ inputs.log_level }}
          assistant_output: ${{ inputs.assistant_output }}
          workspace: ${{ inputs.workspace }}
          input_dir: ${{ steps.ctx.outputs.input_dir }}
          output_dir: ${{ steps.ctx.outputs.output_dir }}
          version: ${{ inputs.version }}
          build_from_source: ${{ inputs.build_from_source }}
          holon_repository: ${{ inputs.holon_repository }}

      - name: Post Summary
        id: result
        if: always()
        run: |
          OUTPUT_DIR='${{ steps.ctx.outputs.output_dir }}'
          SHOULD_RUN="$GATE_SHOULD_RUN"
          REASON="$GATE_REASON"

          if [ "$SHOULD_RUN" != 'true' ]; then
            {
              echo "### Holon skipped"
              echo "- Reason: $REASON"
              echo "- Event: ${{ github.event_name }} (${{ github.event.action }})"
              echo "- Target: #${{ steps.ctx.outputs.issue_number }}"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

          # Check for summary
          if [ -f "$OUTPUT_DIR/summary.md" ]; then
            cat "$OUTPUT_DIR/summary.md" >> "$GITHUB_STEP_SUMMARY"
            echo "summary=$OUTPUT_DIR/summary.md" >> "$GITHUB_OUTPUT"
          else
            echo "summary=" >> "$GITHUB_OUTPUT"
          fi

          # Set result based on job status
          if [ "$SHOULD_RUN" != 'true' ]; then
            echo "result=skipped" >> "$GITHUB_OUTPUT"
          else
            echo "result=${{ steps.run.outcome }}" >> "$GITHUB_OUTPUT"
          fi
        env:
          GATE_SHOULD_RUN: ${{ steps.gate.outputs.should_run }}
          GATE_REASON: ${{ steps.gate.outputs.reason }}

      - name: Post completion feedback
        if: always() && inputs.comment_id != 0 && steps.gate.outputs.should_run == 'true'
        run: |
          set -euo pipefail

          COMMENT_ID='${{ inputs.comment_id }}'
          ISSUE_NUMBER='${{ steps.ctx.outputs.issue_number }}'
          RESULT='${{ steps.result.outputs.result }}'
          REPO='${{ github.repository }}'
          RUN_URL='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'

          # Determine reaction and message based on result
          if [ "$RESULT" = 'success' ]; then
            REACTION_CONTENT='white_check_mark'
            STATUS_TEXT="Holon completed successfully."
          else
            REACTION_CONTENT='x'
            STATUS_TEXT="Holon failed: $RESULT"
          fi

          # Add reaction idempotently (ignore errors if already present)
          gh api --silent -f content="$REACTION_CONTENT" "repos/$REPO/issues/comments/$COMMENT_ID/reactions" 2>/dev/null || true

          # Post reply comment with run URL and status
          gh api "repos/$REPO/issues/$ISSUE_NUMBER/comments" \
            -f body="$STATUS_TEXT

          Run: $RUN_URL"
        env:
          GH_TOKEN: ${{ secrets.holon_github_token || github.token }}

      - name: Bundle Holon Artifact (input + output)
        id: bundle
        if: always()
        run: |
          set -euo pipefail

          INPUT_DIR='${{ steps.ctx.outputs.input_dir }}'
          OUTPUT_DIR='${{ steps.ctx.outputs.output_dir }}'

          ARTIFACT_DIR="$(mktemp -d -t holon-artifact-XXXXXX)"
          mkdir -p "$ARTIFACT_DIR/input" "$ARTIFACT_DIR/output"

          if [ -d "$INPUT_DIR" ]; then
            cp -a "$INPUT_DIR/." "$ARTIFACT_DIR/input/" || true
          fi
          if [ -d "$OUTPUT_DIR" ]; then
            cp -a "$OUTPUT_DIR/." "$ARTIFACT_DIR/output/" || true
          fi

          echo "artifact_dir=$ARTIFACT_DIR" >> "$GITHUB_OUTPUT"

      - name: Upload Holon Artifact (input + output)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: holon-artifact-${{ steps.ctx.outputs.issue_number }}
          path: ${{ steps.bundle.outputs.artifact_dir }}/
          retention-days: 7
